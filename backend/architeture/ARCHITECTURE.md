# üèóÔ∏è Guia de Arquitetura do Backend

## üìö √çndice
1. [Vis√£o Geral](#vis√£o-geral)
2. [Estrutura de Pastas](#estrutura-de-pastas)
3. [Fluxo de Dados](#fluxo-de-dados)
4. [Componentes Principais](#componentes-principais)
5. [Exemplo Pr√°tico: Criando uma Hist√≥ria](#exemplo-pr√°tico)
6. [Exemplo Pr√°tico: Login de Usu√°rio](#exemplo-pr√°tico-login)
7. [Como Adicionar uma Nova Feature](#como-adicionar-nova-feature)

---

## üéØ Vis√£o Geral

Este backend √© constru√≠do com **FastAPI** e segue uma arquitetura em camadas bem definida. Pense nele como uma f√°brica organizada:

```
Cliente (Frontend) 
    ‚Üì
üö™ Router (Recebe pedidos)
    ‚Üì
üìã Schema (Valida os dados)
    ‚Üì
üíº L√≥gica de Neg√≥cio (Processa)
    ‚Üì
üóÑÔ∏è Model (Salva no banco)
    ‚Üì
‚úÖ Resposta para o Cliente
```

---

## üìÅ Estrutura de Pastas

```
backend/
‚îÇ
‚îú‚îÄ‚îÄ main.py                    # üöÄ Ponto de entrada da aplica√ß√£o
‚îÇ
‚îú‚îÄ‚îÄ core/                      # üß† Cora√ß√£o da aplica√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ config.py             # ‚öôÔ∏è Configura√ß√µes (API keys, DB, etc)
‚îÇ   ‚îú‚îÄ‚îÄ prompts.py            # üí¨ Prompts para IA
‚îÇ   ‚îú‚îÄ‚îÄ story_generator.py    # ü§ñ Gerador de hist√≥rias com IA
‚îÇ   ‚îî‚îÄ‚îÄ models.py             # üìä Modelos de dados para IA
‚îÇ
‚îú‚îÄ‚îÄ db/                        # üóÑÔ∏è Banco de dados
‚îÇ   ‚îî‚îÄ‚îÄ database.py           # üîå Conex√£o e sess√£o do banco
‚îÇ
‚îú‚îÄ‚îÄ models/                    # üì¶ Modelos SQLAlchemy (tabelas)
‚îÇ   ‚îú‚îÄ‚îÄ user.py               # üë§ Tabela de usu√°rios
‚îÇ   ‚îú‚îÄ‚îÄ story.py              # üìñ Tabela de hist√≥rias
‚îÇ   ‚îî‚îÄ‚îÄ job.py                # üíº Tabela de jobs ass√≠ncronos
‚îÇ
‚îú‚îÄ‚îÄ schemas/                   # üìã Valida√ß√£o de dados (Pydantic)
‚îÇ   ‚îú‚îÄ‚îÄ user.py               # Schemas de usu√°rio
‚îÇ   ‚îú‚îÄ‚îÄ story.py              # Schemas de hist√≥ria
‚îÇ   ‚îî‚îÄ‚îÄ job.py                # Schemas de job
‚îÇ
‚îú‚îÄ‚îÄ routers/                   # üö™ Endpoints da API
‚îÇ   ‚îú‚îÄ‚îÄ user.py               # Rotas de autentica√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ story.py              # Rotas de hist√≥rias
‚îÇ   ‚îî‚îÄ‚îÄ job.py                # Rotas de jobs
‚îÇ
‚îú‚îÄ‚îÄ alembic/                   # üîÑ Migra√ß√µes de banco de dados
‚îÇ   ‚îî‚îÄ‚îÄ versions/             # Hist√≥rico de mudan√ßas no schema
‚îÇ
‚îú‚îÄ‚îÄ .env                       # üîê Vari√°veis de ambiente (N√ÉO COMMITAR!)
‚îú‚îÄ‚îÄ .env.example              # üìù Template de vari√°veis
‚îú‚îÄ‚îÄ requirements.txt          # üì¶ Depend√™ncias Python
‚îî‚îÄ‚îÄ databse.db               # üíæ Banco SQLite (desenvolvimento)
```

---

## üîÑ Fluxo de Dados

### 1Ô∏è‚É£ Requisi√ß√£o HTTP chega ao servidor

```
POST /api/stories/create
Body: { "theme": "medieval fantasy" }
```

### 2Ô∏è‚É£ Router recebe e direciona

```python
# routers/story.py
@router.post("/stories/create")
def create_story(request: StoryCreateRequest):
    # Este endpoint √© chamado
```

### 3Ô∏è‚É£ Schema valida os dados

```python
# schemas/story.py
class StoryCreateRequest(BaseModel):
    theme: str  # Pydantic valida que theme √© uma string
```

### 4Ô∏è‚É£ L√≥gica de neg√≥cio processa

```python
# core/story_generator.py
generator = StoryGenerator()
story = generator.generate_story(theme)
```

### 5Ô∏è‚É£ Model salva no banco

```python
# models/story.py
new_story = Story(title=title, theme=theme)
db.add(new_story)
db.commit()
```

### 6Ô∏è‚É£ Resposta retorna ao cliente

```json
{
  "story_id": 1,
  "title": "The Dragon's Quest",
  "session_id": "abc-123"
}
```

---

## üß© Componentes Principais

### üöÄ `main.py` - O Maestro

O arquivo `main.py` √© o ponto de entrada. Ele:

```python
from fastapi import FastAPI
from routers import story, job, user

app = FastAPI()  # Cria a aplica√ß√£o

# Registra os routers (grupos de rotas)
app.include_router(story.router, prefix="/api")
app.include_router(job.router, prefix="/api")
app.include_router(user.router, prefix="/api")
```

**Analogia:** √â como o gerente de um restaurante que organiza as diferentes √°reas (cozinha, atendimento, caixa).

---

### üö™ `routers/` - As Portas de Entrada

Cada arquivo em `routers/` define um conjunto de endpoints relacionados.

**Exemplo: `routers/story.py`**

```python
from fastapi import APIRouter

router = APIRouter(prefix="/stories", tags=["stories"])

@router.post("/create")
def create_story(request: StoryCreateRequest):
    # L√≥gica aqui
    return {"story_id": 1}

@router.get("/{story_id}/complete")
def get_story(story_id: int):
    # Buscar hist√≥ria no banco
    return story
```

**Rotas dispon√≠veis:**
- `POST /api/stories/create` ‚Üí Criar hist√≥ria
- `GET /api/stories/{id}/complete` ‚Üí Buscar hist√≥ria completa

**Analogia:** S√£o os gar√ßons que recebem os pedidos dos clientes.

---

### üìã `schemas/` - Os Validadores

Schemas definem a estrutura dos dados usando **Pydantic**.

**Exemplo: `schemas/story.py`**

```python
from pydantic import BaseModel

class StoryCreateRequest(BaseModel):
    theme: str  # Campo obrigat√≥rio

class StoryResponse(BaseModel):
    id: int
    title: str
    session_id: str
    
    class Config:
        from_attributes = True  # Permite converter de SQLAlchemy
```

**Fun√ß√£o:**
- ‚úÖ Valida dados de entrada
- ‚úÖ Define formato de sa√≠da
- ‚úÖ Gera documenta√ß√£o autom√°tica

**Analogia:** √â o card√°pio que diz exatamente o que o cliente pode pedir e o que vai receber.

---

### üóÑÔ∏è `models/` - As Tabelas do Banco

Models definem a estrutura das tabelas usando **SQLAlchemy**.

**Exemplo: `models/story.py`**

```python
from sqlalchemy import Column, Integer, String, DateTime
from db.database import Base

class Story(Base):
    __tablename__ = "stories"
    
    id = Column(Integer, primary_key=True, index=True)
    title = Column(String, index=True)
    session_id = Column(String, index=True)
    created_at = Column(DateTime, server_default=func.now())
    
    # Relacionamento
    nodes = relationship("StoryNode", back_populates="story")
```

**SQL Equivalente:**
```sql
CREATE TABLE stories (
    id INTEGER PRIMARY KEY,
    title VARCHAR,
    session_id VARCHAR,
    created_at DATETIME
);
```

**Analogia:** √â o arquivo de estoque do restaurante que registra tudo o que entra e sai.

---

### üß† `core/` - O C√©rebro

Cont√©m a l√≥gica de neg√≥cio principal.

#### `core/config.py` - Configura√ß√µes

```python
class Settings(BaseSettings):
    API_PREFIX: str = "/api"
    DATABASE_URL: str
    OPENAI_API_KEY: str
    SECRET_KEY: str  # Para JWT
    
    class Config:
        env_file = ".env"  # L√™ do arquivo .env
```

**Carrega vari√°veis do `.env`:**
```env
OPENAI_API_KEY=sk-...
DATABASE_URL=sqlite:///./databse.db
```

#### `core/story_generator.py` - Gerador de Hist√≥rias

```python
class StoryGenerator:
    def generate_story(self, theme: str) -> dict:
        # 1. Cria prompt para IA
        prompt = f"Create a story about {theme}"
        
        # 2. Chama OpenAI via LangChain
        response = llm.invoke(prompt)
        
        # 3. Processa resposta
        story_data = parse_response(response)
        
        return story_data
```

**Fluxo:**
```
Tema ‚Üí Prompt ‚Üí OpenAI ‚Üí JSON ‚Üí Banco de Dados
```

---

### üîå `db/database.py` - Conex√£o com Banco

```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

# Cria engine (conex√£o)
engine = create_engine(settings.DATABASE_URL)

# Cria sess√£o
SessionLocal = sessionmaker(bind=engine)

# Fun√ß√£o para obter sess√£o
def get_db():
    db = SessionLocal()
    try:
        yield db  # Fornece sess√£o
    finally:
        db.close()  # Fecha quando terminar
```

**Uso nos routers:**
```python
@router.post("/stories")
def create_story(db: Session = Depends(get_db)):
    story = Story(title="Test")
    db.add(story)
    db.commit()
```

**Analogia:** √â a conex√£o com o armaz√©m central. Cada requisi√ß√£o pega uma "carreta" (sess√£o) para buscar/entregar dados.

---

## üìñ Exemplo Pr√°tico: Criando uma Hist√≥ria

Vamos seguir o fluxo completo de uma requisi√ß√£o:

### 1. Cliente faz requisi√ß√£o

```javascript
// Frontend
axios.post('/api/stories/create', {
  theme: 'space adventure'
})
```

### 2. Router recebe

```python
# routers/story.py
@router.post("/stories/create")
async def create_story(
    request: StoryCreateRequest,  # ‚Üê Schema valida
    background_tasks: BackgroundTasks,
    db: Session = Depends(get_db)  # ‚Üê Sess√£o do banco
):
    # Gera ID √∫nico para a sess√£o
    session_id = str(uuid.uuid4())
    job_id = str(uuid.uuid4())
    
    # Cria job ass√≠ncrono
    job = StoryJob(
        job_id=job_id,
        session_id=session_id,
        theme=request.theme,
        status="pending"
    )
    db.add(job)
    db.commit()
    
    # Inicia gera√ß√£o em background
    background_tasks.add_task(
        generate_story_background,
        job_id, request.theme, session_id
    )
    
    return {
        "session_id": session_id,
        "job_id": job_id
    }
```

### 3. Background task processa

```python
def generate_story_background(job_id, theme, session_id):
    db = SessionLocal()
    
    try:
        # Busca o job
        job = db.query(StoryJob).filter(
            StoryJob.job_id == job_id
        ).first()
        
        # Gera hist√≥ria com IA
        generator = StoryGenerator()
        story_data = generator.generate_story(theme)
        
        # Salva hist√≥ria
        story = Story(
            title=story_data['title'],
            session_id=session_id
        )
        db.add(story)
        db.commit()
        
        # Salva n√≥s da hist√≥ria
        for node_data in story_data['nodes']:
            node = StoryNode(
                story_id=story.id,
                content=node_data['content'],
                is_root=node_data.get('is_root', False),
                options=node_data.get('options', [])
            )
            db.add(node)
        
        db.commit()
        
        # Atualiza job para completo
        job.status = "completed"
        job.story_id = story.id
        job.completed_at = datetime.utcnow()
        db.commit()
        
    except Exception as e:
        job.status = "failed"
        job.error = str(e)
        db.commit()
    finally:
        db.close()
```

### 4. Cliente verifica status

```javascript
// Frontend faz polling
setInterval(() => {
  axios.get(`/api/jobs/${job_id}`)
    .then(res => {
      if (res.data.status === 'completed') {
        // Buscar hist√≥ria completa
        axios.get(`/api/stories/${story_id}/complete`)
      }
    })
}, 2000)
```

### 5. Buscar hist√≥ria completa

```python
# routers/story.py
@router.get("/{story_id}/complete")
def get_complete_story(story_id: int, db: Session = Depends(get_db)):
    # Busca hist√≥ria com todos os n√≥s
    story = db.query(Story).filter(Story.id == story_id).first()
    
    if not story:
        raise HTTPException(status_code=404)
    
    # SQLAlchemy carrega automaticamente os relacionamentos
    return {
        "id": story.id,
        "title": story.title,
        "session_id": story.session_id,
        "nodes": [
            {
                "id": node.id,
                "content": node.content,
                "is_root": node.is_root,
                "is_ending": node.is_ending,
                "options": node.options
            }
            for node in story.nodes
        ]
    }
```

---

## üîê Exemplo Pr√°tico: Login de Usu√°rio

### 1. Registro de Usu√°rio

```python
# routers/user.py
@router.post("/auth/register")
def register_user(
    request: UserRegisterRequest,
    db: Session = Depends(get_db)
):
    # 1. Verifica se email j√° existe
    existing = db.query(User).filter(
        User.email == request.email
    ).first()
    
    if existing:
        raise HTTPException(400, "Email j√° cadastrado")
    
    # 2. Criptografa senha com bcrypt
    hashed_password = hash_password(request.password)
    
    # 3. Cria usu√°rio
    user = User(
        email=request.email,
        hashed_password=hashed_password
    )
    db.add(user)
    db.commit()
    
    return user  # Schema converte para UserResponse
```

### 2. Login de Usu√°rio

```python
# routers/user.py
@router.post("/auth/login")
def login_user(
    request: UserLoginRequest,
    db: Session = Depends(get_db)
):
    # 1. Busca usu√°rio
    user = db.query(User).filter(
        User.email == request.email
    ).first()
    
    if not user:
        raise HTTPException(401, "Credenciais inv√°lidas")
    
    # 2. Verifica senha
    if not verify_password(request.password, user.hashed_password):
        raise HTTPException(401, "Credenciais inv√°lidas")
    
    # 3. Gera token JWT
    token_data = {"sub": user.email, "user_id": user.id}
    access_token = create_access_token(
        data=token_data,
        expires_delta=timedelta(minutes=30)
    )
    
    # 4. Retorna token
    return {
        "access_token": access_token,
        "token_type": "bearer"
    }
```

### 3. JWT Token

```python
from jose import jwt
from datetime import datetime, timedelta

def create_access_token(data: dict, expires_delta: timedelta):
    to_encode = data.copy()
    expire = datetime.utcnow() + expires_delta
    to_encode.update({"exp": expire})
    
    # Assina com chave secreta
    encoded_jwt = jwt.encode(
        to_encode,
        settings.SECRET_KEY,
        algorithm=settings.ALGORITHM
    )
    return encoded_jwt
```

**Token JWT cont√©m:**
```json
{
  "sub": "user@email.com",
  "user_id": 123,
  "exp": 1696600000
}
```

---

## üÜï Como Adicionar uma Nova Feature

### Exemplo: Adicionar Sistema de Favoritos

#### 1. Criar Model (Tabela)

```python
# models/favorite.py
from sqlalchemy import Column, Integer, ForeignKey
from db.database import Base

class Favorite(Base):
    __tablename__ = "favorites"
    
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"))
    story_id = Column(Integer, ForeignKey("stories.id"))
```

#### 2. Criar Schema (Valida√ß√£o)

```python
# schemas/favorite.py
from pydantic import BaseModel

class FavoriteCreateRequest(BaseModel):
    story_id: int

class FavoriteResponse(BaseModel):
    id: int
    user_id: int
    story_id: int
    
    class Config:
        from_attributes = True
```

#### 3. Criar Router (Endpoints)

```python
# routers/favorite.py
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session

router = APIRouter(prefix="/favorites", tags=["favorites"])

@router.post("/")
def add_favorite(
    request: FavoriteCreateRequest,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)  # Auth
):
    favorite = Favorite(
        user_id=current_user.id,
        story_id=request.story_id
    )
    db.add(favorite)
    db.commit()
    return favorite

@router.get("/")
def get_favorites(
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    favorites = db.query(Favorite).filter(
        Favorite.user_id == current_user.id
    ).all()
    return favorites
```

#### 4. Registrar no main.py

```python
# main.py
from routers import story, job, user, favorite

app.include_router(favorite.router, prefix="/api")
```

#### 5. Criar Migra√ß√£o

```bash
alembic revision --autogenerate -m "Add favorites table"
alembic upgrade head
```

---

## üîç Conceitos Importantes

### Dependency Injection

FastAPI usa **Depends()** para injetar depend√™ncias:

```python
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

@router.get("/stories")
def list_stories(db: Session = Depends(get_db)):
    # db √© automaticamente fornecido e fechado
    return db.query(Story).all()
```

### Background Tasks

Para opera√ß√µes demoradas (gera√ß√£o de hist√≥ria):

```python
@router.post("/stories")
async def create(background_tasks: BackgroundTasks):
    background_tasks.add_task(generate_story)
    return {"status": "processing"}
```

### Relacionamentos SQLAlchemy

```python
class Story(Base):
    nodes = relationship("StoryNode", back_populates="story")

class StoryNode(Base):
    story = relationship("Story", back_populates="nodes")
```

Acesso autom√°tico:
```python
story = db.query(Story).first()
print(story.nodes)  # Lista todos os n√≥s automaticamente
```

---

## üéì Resumo

**Fluxo de uma requisi√ß√£o:**

```
1. Cliente faz HTTP Request
   ‚Üì
2. FastAPI recebe em Router
   ‚Üì
3. Schema valida dados de entrada
   ‚Üì
4. Dependency Injection fornece DB session
   ‚Üì
5. L√≥gica de neg√≥cio processa
   ‚Üì
6. Model interage com banco de dados
   ‚Üì
7. Schema formata resposta
   ‚Üì
8. FastAPI retorna HTTP Response
```

**Organiza√ß√£o:**
- üö™ **Routers** = Portas de entrada (HTTP endpoints)
- üìã **Schemas** = Contratos de dados (valida√ß√£o)
- üóÑÔ∏è **Models** = Tabelas do banco (SQLAlchemy)
- üß† **Core** = L√≥gica de neg√≥cio (IA, processamento)
- üîå **DB** = Conex√£o com banco de dados

**Regra de Ouro:**
> Cada camada tem uma responsabilidade espec√≠fica. N√£o misture l√≥gica de neg√≥cio no router, nem acesso ao banco direto no core!

---

## üìö Pr√≥ximos Passos

1. ‚úÖ Entender o fluxo de dados
2. ‚úÖ Explorar um router espec√≠fico
3. ‚úÖ Modificar um schema existente
4. ‚úÖ Adicionar um novo endpoint
5. ‚úÖ Criar sua primeira feature completa

**Dica:** Comece lendo `routers/story.py` e siga o fluxo at√© o banco de dados!
