# Diagrama ER - Database Schema

Este documento cont√©m o Modelo Entidade-Relacionamento do banco de dados em diferentes formatos.

---

## üìä Diagrama Visual (Mermaid)

```mermaid
erDiagram
    USERS ||--o{ STORIES : "creates"
    STORIES ||--o{ STORY_NODES : "contains"
    STORIES ||--o| STORY_JOBS : "generated_by"

    USERS {
        int id PK "Primary Key"
        string email UK "Unique, Not Null"
        string hashed_password "Not Null"
        datetime created_at "Auto timestamp"
    }

    STORIES {
        int id PK "Primary Key"
        string title "Story title"
        string session_id UK "Unique session ID"
        datetime created_at "Auto timestamp"
    }

    STORY_NODES {
        int id PK "Primary Key"
        int story_id FK "Foreign Key to STORIES"
        string content "Node narrative content"
        boolean is_root "Is starting node"
        boolean is_ending "Is final node"
        boolean is_winning_ending "Is winning ending"
        json options "Available choices"
    }

    STORY_JOBS {
        int id PK "Primary Key"
        string job_id UK "Unique job ID"
        string session_id "Session identifier"
        string theme "Story theme"
        string status "pending/completed/failed"
        int story_id FK "Foreign Key to STORIES"
        string error "Error message if failed"
        datetime created_at "Auto timestamp"
        datetime completed_at "Completion timestamp"
    }
```

---

## üóÇÔ∏è Formato DBML (Database Markup Language)

Use em: https://dbdiagram.io

```dbml
// Use DBML to define your database structure
// Docs: https://dbml.dbdiagram.io/docs

Table users {
  id integer [primary key, increment, note: 'Auto-incrementing ID']
  email varchar [unique, not null, note: 'User email address']
  hashed_password varchar [not null, note: 'Bcrypt hashed password']
  created_at timestamp [default: `now()`, note: 'Account creation time']
  
  Indexes {
    id [name: 'idx_users_id']
    email [name: 'idx_users_email']
  }
}

Table stories {
  id integer [primary key, increment, note: 'Auto-incrementing ID']
  title varchar [note: 'Generated story title']
  session_id varchar [unique, note: 'Unique session identifier']
  created_at timestamp [default: `now()`, note: 'Story creation time']
  
  Indexes {
    id [name: 'idx_stories_id']
    title [name: 'idx_stories_title']
    session_id [name: 'idx_stories_session_id']
  }
}

Table story_nodes {
  id integer [primary key, increment, note: 'Auto-incrementing ID']
  story_id integer [ref: > stories.id, not null, note: 'Foreign key to stories']
  content text [note: 'Narrative content of the node']
  is_root boolean [default: false, note: 'True if starting node']
  is_ending boolean [default: false, note: 'True if ending node']
  is_winning_ending boolean [default: false, note: 'True if winning ending']
  options json [note: 'Array of choices as JSON']
  
  Indexes {
    id [name: 'idx_story_nodes_id']
    story_id [name: 'idx_story_nodes_story_id']
  }
}

Table story_jobs {
  id integer [primary key, increment, note: 'Auto-incrementing ID']
  job_id varchar [unique, not null, note: 'Unique job identifier (UUID)']
  session_id varchar [note: 'Session identifier']
  theme varchar [note: 'Story theme/prompt']
  status varchar [note: 'Job status: pending, completed, failed']
  story_id integer [ref: > stories.id, note: 'Foreign key to generated story']
  error varchar [note: 'Error message if job failed']
  created_at timestamp [default: `now()`, note: 'Job creation time']
  completed_at timestamp [note: 'Job completion time']
  
  Indexes {
    id [name: 'idx_story_jobs_id']
    job_id [name: 'idx_story_jobs_job_id']
    session_id [name: 'idx_story_jobs_session_id']
  }
}

// Relationships
Ref: story_nodes.story_id > stories.id [delete: cascade]
Ref: story_jobs.story_id > stories.id [delete: set null]
```

---

## üî∑ Formato PlantUML

Use em: http://www.plantuml.com/plantuml/uml/

```plantuml
@startuml Database_ER_Diagram

!define Table(name,desc) class name as "desc" << (T,#FFAAAA) >>
!define primary_key(x) <b><u>x</u></b>
!define foreign_key(x) <i>x</i>
!define unique(x) <color:green>x</color>
!define not_null(x) <color:red>x</color>

hide methods
hide stereotypes

' Tables
entity "users" as users {
  primary_key(id) : INTEGER
  unique(email) : VARCHAR
  not_null(hashed_password) : VARCHAR
  created_at : TIMESTAMP
}

entity "stories" as stories {
  primary_key(id) : INTEGER
  title : VARCHAR
  unique(session_id) : VARCHAR
  created_at : TIMESTAMP
}

entity "story_nodes" as story_nodes {
  primary_key(id) : INTEGER
  foreign_key(story_id) : INTEGER
  content : TEXT
  is_root : BOOLEAN
  is_ending : BOOLEAN
  is_winning_ending : BOOLEAN
  options : JSON
}

entity "story_jobs" as story_jobs {
  primary_key(id) : INTEGER
  unique(job_id) : VARCHAR
  session_id : VARCHAR
  theme : VARCHAR
  status : VARCHAR
  foreign_key(story_id) : INTEGER
  error : VARCHAR
  created_at : TIMESTAMP
  completed_at : TIMESTAMP
}

' Relationships
stories ||--o{ story_nodes : "has many"
stories ||--o| story_jobs : "generated by"

note right of stories
  Each story can have
  multiple nodes forming
  a branching narrative
end note

note right of story_jobs
  Jobs track async
  story generation
  process
end note

@enduml
```

---

## üìê SQL DDL (Data Definition Language)

```sql
-- ============================================
-- Interactive Story Generator - Database Schema
-- ============================================

-- Users Table
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    email VARCHAR(255) UNIQUE NOT NULL,
    hashed_password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- Indexes
    INDEX idx_users_id (id),
    INDEX idx_users_email (email)
);

-- Stories Table
CREATE TABLE stories (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title VARCHAR(500),
    session_id VARCHAR(100) UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- Indexes
    INDEX idx_stories_id (id),
    INDEX idx_stories_title (title),
    INDEX idx_stories_session_id (session_id)
);

-- Story Nodes Table
CREATE TABLE story_nodes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    story_id INTEGER NOT NULL,
    content TEXT,
    is_root BOOLEAN DEFAULT FALSE,
    is_ending BOOLEAN DEFAULT FALSE,
    is_winning_ending BOOLEAN DEFAULT FALSE,
    options JSON,
    
    -- Foreign Key
    FOREIGN KEY (story_id) REFERENCES stories(id) ON DELETE CASCADE,
    
    -- Indexes
    INDEX idx_story_nodes_id (id),
    INDEX idx_story_nodes_story_id (story_id)
);

-- Story Jobs Table
CREATE TABLE story_jobs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    job_id VARCHAR(100) UNIQUE NOT NULL,
    session_id VARCHAR(100),
    theme VARCHAR(500),
    status VARCHAR(50),
    story_id INTEGER,
    error TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP,
    
    -- Foreign Key
    FOREIGN KEY (story_id) REFERENCES stories(id) ON DELETE SET NULL,
    
    -- Indexes
    INDEX idx_story_jobs_id (id),
    INDEX idx_story_jobs_job_id (job_id),
    INDEX idx_story_jobs_session_id (session_id)
);
```

---

## üìä Descri√ß√£o Detalhada das Tabelas

### 1. `users` - Usu√°rios do Sistema

| Coluna | Tipo | Restri√ß√µes | Descri√ß√£o |
|--------|------|------------|-----------|
| **id** | INTEGER | PRIMARY KEY, AUTO INCREMENT | Identificador √∫nico do usu√°rio |
| **email** | VARCHAR | UNIQUE, NOT NULL, INDEX | Email do usu√°rio (usado para login) |
| **hashed_password** | VARCHAR | NOT NULL | Senha criptografada com bcrypt |
| **created_at** | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | Data de cria√ß√£o da conta |

**Relacionamentos:**
- Futuramente: Um usu√°rio pode criar v√°rias hist√≥rias (1:N com `stories`)

---

### 2. `stories` - Hist√≥rias Geradas

| Coluna | Tipo | Restri√ß√µes | Descri√ß√£o |
|--------|------|------------|-----------|
| **id** | INTEGER | PRIMARY KEY, AUTO INCREMENT | Identificador √∫nico da hist√≥ria |
| **title** | VARCHAR | INDEX | T√≠tulo gerado pela IA |
| **session_id** | VARCHAR | UNIQUE, INDEX | Identificador √∫nico da sess√£o |
| **created_at** | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | Data de cria√ß√£o |

**Relacionamentos:**
- **1:N** com `story_nodes` - Uma hist√≥ria tem v√°rios n√≥s
- **1:1** com `story_jobs` - Uma hist√≥ria √© gerada por um job

---

### 3. `story_nodes` - N√≥s da Narrativa

| Coluna | Tipo | Restri√ß√µes | Descri√ß√£o |
|--------|------|------------|-----------|
| **id** | INTEGER | PRIMARY KEY, AUTO INCREMENT | Identificador √∫nico do n√≥ |
| **story_id** | INTEGER | FOREIGN KEY, NOT NULL, INDEX | Refer√™ncia √† hist√≥ria pai |
| **content** | TEXT | - | Conte√∫do narrativo do n√≥ |
| **is_root** | BOOLEAN | DEFAULT FALSE | Se √© o n√≥ inicial |
| **is_ending** | BOOLEAN | DEFAULT FALSE | Se √© um n√≥ final |
| **is_winning_ending** | BOOLEAN | DEFAULT FALSE | Se √© um final vitorioso |
| **options** | JSON | - | Array de op√ß√µes/escolhas |

**Relacionamentos:**
- **N:1** com `stories` - V√°rios n√≥s pertencem a uma hist√≥ria

**Estrutura JSON de `options`:**
```json
[
  {
    "text": "Go north to the castle",
    "next_node_id": 2
  },
  {
    "text": "Go south to the village",
    "next_node_id": 3
  }
]
```

---

### 4. `story_jobs` - Jobs de Gera√ß√£o Ass√≠ncrona

| Coluna | Tipo | Restri√ß√µes | Descri√ß√£o |
|--------|------|------------|-----------|
| **id** | INTEGER | PRIMARY KEY, AUTO INCREMENT | Identificador √∫nico do job |
| **job_id** | VARCHAR | UNIQUE, NOT NULL, INDEX | UUID do job |
| **session_id** | VARCHAR | INDEX | Identificador da sess√£o |
| **theme** | VARCHAR | - | Tema fornecido pelo usu√°rio |
| **status** | VARCHAR | - | Status: `pending`, `completed`, `failed` |
| **story_id** | INTEGER | FOREIGN KEY, NULLABLE | Refer√™ncia √† hist√≥ria gerada |
| **error** | TEXT | NULLABLE | Mensagem de erro se falhou |
| **created_at** | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | In√≠cio do job |
| **completed_at** | TIMESTAMP | NULLABLE | Fim do job |

**Relacionamentos:**
- **1:1** com `stories` - Um job gera uma hist√≥ria

**Estados do Job:**
- `pending` - Job iniciado, aguardando processamento
- `completed` - Hist√≥ria gerada com sucesso
- `failed` - Erro na gera√ß√£o (veja campo `error`)

---

## üîó Relacionamentos Detalhados

### 1. `stories` ‚Üê‚Üí `story_nodes` (One-to-Many)

```
stories (1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ
                    ‚îÇ has many
                    ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) story_nodes
```

**SQLAlchemy:**
```python
# models/story.py
class Story(Base):
    nodes = relationship("StoryNode", back_populates="story")

class StoryNode(Base):
    story_id = Column(Integer, ForeignKey("stories.id"))
    story = relationship("Story", back_populates="nodes")
```

**Cascade:** `ON DELETE CASCADE` - Deletar hist√≥ria deleta todos os n√≥s

---

### 2. `stories` ‚Üê‚Üí `story_jobs` (One-to-One)

```
stories (1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ
                    ‚îÇ generated by
                    ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (1) story_jobs
```

**Cascade:** `ON DELETE SET NULL` - Deletar hist√≥ria mant√©m job mas limpa `story_id`

---

## üéØ Cen√°rios de Uso

### Cen√°rio 1: Criar Nova Hist√≥ria

```sql
-- 1. Criar job
INSERT INTO story_jobs (job_id, session_id, theme, status)
VALUES ('uuid-123', 'session-456', 'medieval fantasy', 'pending');

-- 2. Gerar hist√≥ria (background)
INSERT INTO stories (title, session_id)
VALUES ('The Dragon Quest', 'session-456');

-- 3. Adicionar n√≥s
INSERT INTO story_nodes (story_id, content, is_root, options)
VALUES (1, 'You stand before a castle...', TRUE, '[...]');

-- 4. Atualizar job
UPDATE story_jobs
SET status = 'completed', story_id = 1, completed_at = CURRENT_TIMESTAMP
WHERE job_id = 'uuid-123';
```

### Cen√°rio 2: Buscar Hist√≥ria Completa

```sql
-- Busca hist√≥ria com todos os n√≥s
SELECT 
    s.id, s.title, s.session_id,
    n.id as node_id, n.content, n.is_root, n.options
FROM stories s
LEFT JOIN story_nodes n ON s.id = n.story_id
WHERE s.id = 1;
```

### Cen√°rio 3: Verificar Status do Job

```sql
SELECT job_id, status, error, story_id, completed_at
FROM story_jobs
WHERE job_id = 'uuid-123';
```

---

## üîß Ferramentas para Visualizar

### Online (Recomendado)
1. **dbdiagram.io** - Cole o c√≥digo DBML acima
   - URL: https://dbdiagram.io
   - ‚úÖ Mais f√°cil e visual
   - ‚úÖ Exporta para PNG/PDF/SQL

2. **PlantUML Online** - Cole o c√≥digo PlantUML
   - URL: http://www.plantuml.com/plantuml/uml/
   - ‚úÖ Gera diagramas UML

3. **Mermaid Live Editor** - Cole o c√≥digo Mermaid
   - URL: https://mermaid.live
   - ‚úÖ Funciona no GitHub/GitLab

### Desktop
1. **DBeaver** - Visualizador de banco de dados
   - Conecta no SQLite e mostra ER automaticamente

2. **MySQL Workbench** - Designer de BD
   - Importa SQL DDL e gera diagrama

3. **Visual Studio Code** - Com extens√µes
   - Extens√£o: "Mermaid Preview"
   - Extens√£o: "PlantUML"

---

## üì∏ Preview do Diagrama

O diagrama gerado mostrar√°:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    USERS    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ (future)
      ‚îÇ
      ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   STORIES   ‚îÇ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  STORY_JOBS  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  1:1    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ
      ‚îÇ 1:N
      ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ STORY_NODES ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üé® Cores Sugeridas para Diagramas

- üîµ **Azul** - Tabelas principais (stories, users)
- üü¢ **Verde** - Tabelas de relacionamento (story_nodes)
- üü° **Amarelo** - Tabelas de controle (story_jobs)
- üî¥ **Vermelho** - Chaves prim√°rias
- üü£ **Roxo** - Chaves estrangeiras

---

**Escolha o formato que preferir e visualize seu banco de dados!** üìä‚ú®
